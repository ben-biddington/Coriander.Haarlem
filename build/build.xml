<?xml version="1.0"?>
<project name="jarify" basedir="..\">
    <property name="app.name" value="Coriander.Haarlem"/>
    <property name="plugin.name" value="coriander-haarlem-simple-plugin"/>
    <property name="app.path" value="\${app.name}"/>
    <property name="app.version" value="0.0.1"/>
    <property name="src.home" value="${basedir}\src"/>
    <property name="build.home" value="${basedir}\out"/>
    <property name="jar.home" value="${build.home}\jar"/>
    <property name="jar.name" value="${plugin.name}-${app.version}.jar"/>

    <target name="clean">
        <delete dir="${jar.home}" verbose="true"/>
        <delete dir="${basedir}\buildServerResources" verbose="true"/>
    </target>

    <target name="package.buildServerResources">
        <copyfile
            src="${basedir}\src\coriander\haarlem\views\include-internal.jsp"
            dest="${basedir}\buildServerResources\include-internal.jsp"
        />
        <copyfile
            src="${basedir}\src\coriander\haarlem\views\default.jsp"
            dest="${basedir}\buildServerResources\default.jsp"
        />
        <copyfile
            src="${basedir}\src\coriander\haarlem\views\dilbert.jsp"
            dest="${basedir}\buildServerResources\dilbert.jsp"
        />
    </target>

    <target name="jar" depends="clean,package.buildServerResources">
        <mkdir dir="${jar.home}"/>

        <jar
            destfile="${jar.home}\${jar.name}"
            basedir="${build.home}\production\${app.name}"
        >
            <metainf dir="${basedir}\build">
                <include name="build-server-plugin-coriander-haarlem.xml" />
            </metainf>

            <fileset dir="${basedir}">
                <include name="buildServerResources\include-internal.jsp" />
                <include name="buildServerResources\default.jsp" />
                <include name="buildServerResources\dilbert.jsp" />
            </fileset>

            <manifest>
                <attribute name="Author" value="Various"/>
                <attribute name="Version" value="${app.version}"/>
            </manifest>
        </jar>
    </target>

    <target name="local.deploy" depends="jar,clean">
        <exec executable="cmd">
            <arg value="/c"/>
            <arg value="build\local.deploy.bat ${jar.home}\${jar.name}"/>
            <arg value="-p"/>
        </exec>
        <antcall target="local.teamcity.restart" />
    </target>

     <target name="local.clean" depends="">
        <exec executable="cmd">
            <arg value="/c"/>
            <arg value="build\local.clean.bat ${jar.home}\${jar.name}"/>
            <arg value="-p"/>
        </exec>
    </target>

    <target name="local.teamcity.restart" description="Restarting teamcity">
        <exec executable="cmd">
            <arg value="/c"/>
            <arg value="build\restart-teamcity.bat ${jar.home}"/>
            <arg value="-p"/>
        </exec>
    </target>
</project>